datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  avatar    String?
  role      String   @default("Member") // Admin, Team Lead, Member
  workspace   Workspace? @relation(fields: [workspaceId], references: [id], onDelete: SetNull)
  workspaceId String?
  subteams  Subteam[]
  tasks     Task[]   @relation("TaskAssignee")
  taskAssignments TaskAssignee[] @relation("TaskAssignments")
  projects  Project[] @relation("ProjectLead")
  projectMemberships ProjectMember[] @relation("ProjectMembers")
  memberships WorkspaceMember[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Subteam {
  id      String @id @default(cuid())
  name    String
  color   String
  users   User[]
  tasks   Task[]
  workspace   Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  workspaceId String?
}

model Project {
  id          String   @id @default(cuid())
  name        String
  description String?
  difficulty  String   @default("Medium") // Easy, Medium, Hard
  lead        User?    @relation("ProjectLead", fields: [leadId], references: [id])
  leadId      String?
  workspace   Workspace? @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  workspaceId String?
  sprints     Sprint[]
  boards      Board[]
  whiteboards Whiteboard[]
  members     ProjectMember[] @relation("ProjectMembers")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ProjectMember {
  id        String   @id @default(cuid())
  project   Project  @relation("ProjectMembers", fields: [projectId], references: [id], onDelete: Cascade)
  projectId String
  user      User     @relation("ProjectMembers", fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  createdAt DateTime @default(now())
  
  @@unique([projectId, userId])
}

model Sprint {
  id        String   @id @default(cuid())
  name      String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId String
  startDate DateTime
  endDate   DateTime
  status    String   @default("Active") // Active, Completed
  color     String   @default("#3b82f6") // Color for Gantt view
  tasks     Task[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Board {
  id        String   @id @default(cuid())
  name      String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId String
  columns   Column[]
}

model Column {
  id        String @id @default(cuid())
  name      String
  board     Board  @relation(fields: [boardId], references: [id], onDelete: Cascade)
  boardId   String
  tasks     Task[]
  order     Int    @default(0)
}

model Task {
  id              String   @id @default(cuid())
  title           String
  description     String?
  status          String   @default("Todo") 
  assignee        User?    @relation("TaskAssignee", fields: [assigneeId], references: [id])
  assigneeId      String?
  assignees       TaskAssignee[]
  sprint          Sprint?  @relation(fields: [sprintId], references: [id], onDelete: Cascade)
  sprintId        String?
  column          Column?  @relation(fields: [columnId], references: [id], onDelete: Cascade)
  columnId        String?
  subteam         Subteam? @relation(fields: [subteamId], references: [id], onDelete: SetNull)
  subteamId       String?
  priority        String   @default("Medium")
  difficulty      String   @default("Medium") // Easy, Medium, Hard
  requireAttachment Boolean @default(true)
  instructionsFileUrl  String?  // Optional instructions file URL
  instructionsFileName String?  // Original filename
  startDate       DateTime?
  endDate         DateTime?
  dueDate         DateTime?
  comments        Comment[]
  attachments     TaskAttachment[]
  activityLogs    ActivityLog[]
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

model TaskAssignee {
  id        String   @id @default(cuid())
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId    String
  user      User     @relation("TaskAssignments", fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  createdAt DateTime @default(now())
  
  @@unique([taskId, userId])
}

model Comment {
  id         String    @id @default(cuid())
  content    String
  task       Task      @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId     String
  authorId   String   
  authorName String    @default("User")
  replyTo    Comment?  @relation("CommentReplies", fields: [replyToId], references: [id], onDelete: SetNull)
  replyToId  String?
  replies    Comment[] @relation("CommentReplies")
  createdAt  DateTime  @default(now())
}

model TaskAttachment {
  id        String   @id @default(cuid())
  name      String
  url       String
  size      Int      @default(0)
  type      String   @default("file")
  order     Int      @default(0)
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId    String
  uploadedBy String
  createdAt DateTime @default(now())
}

model Whiteboard {
  id        String   @id @default(cuid())
  name      String   @default("Untitled")
  project   Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId String?
  data      String   // JSON string
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model ActivityLog {
  id          String   @id @default(cuid())
  task        Task?    @relation(fields: [taskId], references: [id], onDelete: SetNull)
  taskId      String?
  taskTitle   String?  // Store task title for deleted tasks
  action      String   // e.g., "updated", "moved", "created", "deleted"
  field       String?  // Field that was changed (e.g., "description", "assignee", "difficulty")
  oldValue    String?  // Previous value (JSON string for complex values)
  newValue    String?  // New value (JSON string for complex values)
  changedBy   String   // User ID who made the change
  changedByName String // User name who made the change
  details     String?  // Additional details about the change
  createdAt   DateTime @default(now())
}

model Invite {
  id        String   @id @default(cuid())
  token     String   @unique
  role      String   @default("Member") // Admin, Team Lead, Member
  expiresAt DateTime?
  maxUses   Int      @default(1)
  uses      Int      @default(0)
  createdBy String
  createdAt DateTime @default(now())
}

model WorkspaceConfig {
  id        String   @id @default("default")
  name      String   @default("My Workspace")
  updatedAt DateTime @updatedAt
}


model Workspace {
  id               String    @id @default(cuid())
  name             String
  inviteCode       String    @unique
  discordChannelId String?
  ownerId          String
  users            User[]
  subteams         Subteam[]
  members          WorkspaceMember[]
  projects         Project[]
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
}

model WorkspaceMember {
  id          String    @id @default(cuid())
  user        User      @relation(fields: [userId], references: [id])
  userId      String
  workspace   Workspace @relation(fields: [workspaceId], references: [id], onDelete: Cascade)
  workspaceId String
  role        String    @default("Member") // Admin, Team Lead, Member
  name        String    // Workspace specific name
  joinedAt    DateTime  @default(now())

  @@unique([userId, workspaceId])
}

model Notification {
  id          String    @id @default(cuid())
  workspaceId String
  userId      String?   // null = broadcast to all workspace members
  type        String    // member_joined, task_due, task_assigned, etc
  title       String
  message     String
  link        String?   // Optional link to navigate to
  read        Boolean   @default(false)
  createdAt   DateTime  @default(now())

  @@index([workspaceId, userId])
  @@index([workspaceId, read])
}
